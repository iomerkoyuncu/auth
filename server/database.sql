CREATE DATABASE auth_db;

CREATE TABLE USERS (
  USER_ID SERIAL PRIMARY KEY,
  EMAIL VARCHAR UNIQUE,
  PASSWORD VARCHAR NOT NULL,
  NAME VARCHAR NOT NULL,
  CREATED_AT TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  UPDATED_AT TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

CREATE TABLE PERMISSIONS (
  PERMISSION_ID VARCHAR UNIQUE NOT NULL,
  DESCRIPTION VARCHAR,
  PRIMARY KEY (PERMISSION_ID)
);

CREATE TABLE ROLES (
  ROLE_ID VARCHAR UNIQUE NOT NULL,  
  DESCRIPTION VARCHAR,
  CREATED_AT TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  UPDATED_AT TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  PRIMARY KEY (ROLE_ID)
);

CREATE TABLE ROLE_PERMISSIONS (
  ROLE_PERMISSION_ID SERIAL UNIQUE NOT NULL,
  PERMISSION_ID VARCHAR NOT NULL,
  ROLE_ID VARCHAR NOT NULL,
  CREATED_AT TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  UPDATED_AT TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  PRIMARY KEY (ROLE_PERMISSION_ID),
  UNIQUE (PERMISSION_ID, ROLE_ID),
  FOREIGN KEY (PERMISSION_ID) REFERENCES PERMISSIONS
  (PERMISSION_ID) ON DELETE CASCADE ON UPDATE CASCADE,
  FOREIGN KEY (ROLE_ID) REFERENCES ROLES (ROLE_ID) ON DELETE
  CASCADE ON UPDATE CASCADE
);

CREATE TABLE USER_ROLES (
  USER_ROLE_ID SERIAL UNIQUE NOT NULL,
  USER_ID SERIAL NOT NULL,
  ROLE_ID VARCHAR NOT NULL,
  CREATED_AT TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  UPDATED_AT TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  PRIMARY KEY (USER_ROLE_ID),
  UNIQUE (USER_ID, ROLE_ID),
  FOREIGN KEY (USER_ID) REFERENCES USERS (USER_ID) ON DELETE
  CASCADE ON UPDATE CASCADE,
  FOREIGN KEY (ROLE_ID) REFERENCES ROLES (ROLE_ID) ON DELETE
  CASCADE ON UPDATE CASCADE
);

INSERT INTO PERMISSIONS (PERMISSION_ID)
VALUES ('USER_CREATE');
INSERT INTO PERMISSIONS (PERMISSION_ID)
VALUES ('USER_UPDATE');
INSERT INTO PERMISSIONS (PERMISSION_ID)
VALUES ('USER_READ');
INSERT INTO PERMISSIONS (PERMISSION_ID)
VALUES ('USER_DELETE');
INSERT INTO ROLES (ROLE_ID)
VALUES ('ROOT');
INSERT INTO ROLES (ROLE_ID)
VALUES ('OBSERVER');
INSERT INTO ROLE_PERMISSIONS (PERMISSION_ID, ROLE_ID)
VALUES ('USER_CREATE', 'ROOT');
INSERT INTO ROLE_PERMISSIONS (PERMISSION_ID, ROLE_ID)
VALUES ('USER_UPDATE', 'ROOT');
INSERT INTO ROLE_PERMISSIONS (PERMISSION_ID, ROLE_ID)
VALUES ('USER_READ', 'ROOT');
INSERT INTO ROLE_PERMISSIONS (PERMISSION_ID, ROLE_ID)
VALUES ('USER_DELETE', 'ROOT');
INSERT INTO ROLE_PERMISSIONS (PERMISSION_ID, ROLE_ID)
VALUES ('USER_READ', 'OBSERVER');